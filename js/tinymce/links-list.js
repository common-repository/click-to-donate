var ClickToDonateLinks;(function(f){var b={},e={},d,a,c;ClickToDonateLinks={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",init:function(){b.dialog=f("#ClickToDonateLinks");b.submit=f("#ClickToDonateLinks-submit");b.url=f("#ctd-url-field");b.nonce=f("#_ajax_ctd_links_nonce");b.name=f("#ctd-campaign-name-field");b.title=f("#ctd-link-title-field");b.openInNewTab=f("#ctd-link-target-checkbox");b.search=f("#ctd-search-field");e.search=new a(f("#ctd-search-results"));e.recent=new a(f("#ctd-most-recent-results"));e.elements=f(".ctd-query-results",b.dialog);b.dialog.keydown(ClickToDonateLinks.keydown);b.dialog.keyup(ClickToDonateLinks.keyup);b.submit.click(function(g){g.preventDefault();ClickToDonateLinks.update()});f("#ctd-links-cancel").click(function(g){g.preventDefault();ClickToDonateLinks.close()});f("#ctd-internal-toggle").click(ClickToDonateLinks.toggleInternalLinking);e.elements.bind("river-select",ClickToDonateLinks.updateFields);b.search.keyup(ClickToDonateLinks.searchInternalLinks);b.dialog.bind("wpdialogrefresh",ClickToDonateLinks.refresh);b.dialog.bind("wpdialogbeforeopen",ClickToDonateLinks.beforeOpen);b.dialog.bind("wpdialogclose",ClickToDonateLinks.onClose)},beforeOpen:function(){ClickToDonateLinks.range=null;f("#ctd-campaign-name-field-wrapper").hide();if(!ClickToDonateLinks.isMCE()&&document.selection){ClickToDonateLinks.textarea.focus();ClickToDonateLinks.range=document.selection.createRange()}},open:function(){if(!wpActiveEditor){return}this.textarea=f("#"+wpActiveEditor).get(0);if(!b.dialog.data("wpdialog")){b.dialog.wpdialog({title:ctdLinksListL10n.title,width:480,height:"auto",modal:true,dialogClass:"wp-dialog",zIndex:300000})}b.dialog.wpdialog("open")},isMCE:function(){return tinyMCEPopup&&(d=tinyMCEPopup.editor)&&!d.isHidden()},refresh:function(){e.search.refresh();e.recent.refresh();if(ClickToDonateLinks.isMCE()){ClickToDonateLinks.mceRefresh()}else{ClickToDonateLinks.setDefaultValues()}b.url.focus()[0].select();if(!e.recent.ul.children().length){e.recent.ajax()}},mceRefresh:function(){var i,h,g;d=tinyMCEPopup.editor;tinyMCEPopup.restoreSelection();if(i=d.dom.getParent(d.selection.getNode(),"A")){b.url.val(d.dom.getAttrib(i,"href"));b.title.val(d.dom.getAttrib(i,"title"));h=d.dom.getAttrib(i,"href").match(/^#ctd\-(\d+)$/i);if(h&&h[1]){b.name.html(ctdLinksListL10n.loadingCampaign.replace("{0}",h[1]));f("#ctd-campaign-name-field-wrapper").show();g=new c("#ctd-"+h[1]);g.ajax(function(j,k){if(j){b.name.html(h[1]);f.each(j,function(){if(this["ID"]==h[1]){b.name.html("<a href='"+this["permalink"]+"' target='_blank'>"+this["title"]+"</a>")}})}})}else{b.name.html("");f("#ctd-internal-toggle").trigger("click");f("#ctd-campaign-name-field-wrapper").hide()}if("_blank"==d.dom.getAttrib(i,"target")){b.openInNewTab.prop("checked",true)}b.submit.val(ctdLinksListL10n.update)}else{ClickToDonateLinks.setDefaultValues()}tinyMCEPopup.storeSelection()},close:function(){if(ClickToDonateLinks.isMCE()){tinyMCEPopup.close()}else{b.dialog.wpdialog("close")}},onClose:function(){if(!ClickToDonateLinks.isMCE()){ClickToDonateLinks.textarea.focus();if(ClickToDonateLinks.range){ClickToDonateLinks.range.moveToBookmark(ClickToDonateLinks.range.getBookmark());ClickToDonateLinks.range.select()}}},getAttrs:function(){return{href:b.url.val(),title:b.title.val(),target:b.openInNewTab.prop("checked")?"_blank":""}},update:function(){if(ClickToDonateLinks.isMCE()){ClickToDonateLinks.mceUpdate()}else{ClickToDonateLinks.htmlUpdate()}},htmlUpdate:function(){var i,j,l,h,k,g=ClickToDonateLinks.textarea;if(!g){return}i=ClickToDonateLinks.getAttrs();if(!i.href||i.href=="http://"||i.href=="#"){return}j='<a href="'+i.href+'"';if(i.title){j+=' title="'+i.title+'"'}if(i.target){j+=' target="'+i.target+'"'}j+=">";if(typeof g.selectionStart!=="undefined"){l=g.selectionStart;h=g.selectionEnd;selection=g.value.substring(l,h);j=j+selection+"</a>";k=l+j.length;if(l==h){k-="</a>".length}g.value=g.value.substring(0,l)+j+g.value.substring(h,g.value.length);g.selectionStart=g.selectionEnd=k}else{if(document.selection&&ClickToDonateLinks.range){g.focus();ClickToDonateLinks.range.text=j+ClickToDonateLinks.range.text+"</a>";ClickToDonateLinks.range.moveToBookmark(ClickToDonateLinks.range.getBookmark());ClickToDonateLinks.range.select();ClickToDonateLinks.range=null}}ClickToDonateLinks.close();g.focus()},mceUpdate:function(){var h=tinyMCEPopup.editor,i=ClickToDonateLinks.getAttrs(),j,g;tinyMCEPopup.restoreSelection();j=h.dom.getParent(h.selection.getNode(),"A");if(!i.href||i.href=="http://"||i.href=="#"){if(j){tinyMCEPopup.execCommand("mceBeginUndoLevel");g=h.selection.getBookmark();h.dom.remove(j,1);h.selection.moveToBookmark(g);tinyMCEPopup.execCommand("mceEndUndoLevel");ClickToDonateLinks.close()}return}tinyMCEPopup.execCommand("mceBeginUndoLevel");if(j==null){h.getDoc().execCommand("unlink",false,null);tinyMCEPopup.execCommand("CreateLink",false,"#mce_temp_url#",{skip_undo:1});tinymce.each(h.dom.select("a"),function(k){if(h.dom.getAttrib(k,"href")=="#mce_temp_url#"){j=k;h.dom.setAttribs(j,i)}});if(f(j).text()=="#mce_temp_url#"){h.dom.remove(j);j=null}}else{h.dom.setAttribs(j,i)}if(j&&(j.childNodes.length!=1||j.firstChild.nodeName!="IMG")){h.focus();h.selection.select(j);h.selection.collapse(0);tinyMCEPopup.storeSelection()}tinyMCEPopup.execCommand("mceEndUndoLevel");ClickToDonateLinks.close()},updateFields:function(i,h,g){b.url.val(h.children(".item-link").val());b.title.val(h.hasClass("no-title")?"":h.children(".item-title").text());b.name.html("<a href='"+h.children(".item-permalink").val()+"' target='_blank'>"+b.title.val()+"</a>");f("#ctd-campaign-name-field-wrapper").show();if(g&&g.type=="click"){b.url.focus()}},setDefaultValues:function(){b.url.val("#");b.title.val("");b.submit.val(ctdLinksListL10n.save)},searchInternalLinks:function(){var h=f(this),i,g=h.val();if(g.length>1){e.recent.hide();e.search.show();if(ClickToDonateLinks.lastSearch==g){return}ClickToDonateLinks.lastSearch=g;i=h.siblings("img.waiting").show();e.search.change(g);e.search.ajax(function(){i.hide()})}else{e.search.hide();e.recent.show()}},next:function(){e.search.next();e.recent.next()},prev:function(){e.search.prev();e.recent.prev()},keydown:function(i){var h,g=f.ui.keyCode;switch(i.which){case g.UP:h="prev";case g.DOWN:h=h||"next";clearInterval(ClickToDonateLinks.keyInterval);ClickToDonateLinks[h]();ClickToDonateLinks.keyInterval=setInterval(ClickToDonateLinks[h],ClickToDonateLinks.keySensitivity);break;default:return}i.preventDefault()},keyup:function(h){var g=f.ui.keyCode;switch(h.which){case g.ESCAPE:h.stopImmediatePropagation();if(!f(document).triggerHandler("wp_CloseOnEscape",[{event:h,what:"ClickToDonate",cb:ClickToDonateLinks.close}])){ClickToDonateLinks.close()}return false;break;case g.UP:case g.DOWN:clearInterval(ClickToDonateLinks.keyInterval);break;default:return}h.preventDefault()},delayedCallback:function(i,g){var l,k,j,h;if(!g){return i}setTimeout(function(){if(k){return i.apply(h,j)}l=true},g);return function(){if(l){return i.apply(this,arguments)}j=arguments;h=this;k=true}},toggleInternalLinking:function(h){var g=f("#ctd-search-panel"),i=b.dialog.wpdialog("widget"),k=!g.is(":visible"),j=f(window);f(this).toggleClass("ctd-toggle-arrow-active",k);b.dialog.height("auto");g.slideToggle(300,function(){setUserSetting("ctd-links",k?"1":"0");b[k?"search":"title"].focus();var l=j.scrollTop(),o=i.offset().top,m=o+i.outerHeight(),n=m-j.height();if(n>l){i.animate({top:n<o?o-n:l},200)}});h.preventDefault()}};a=function(i,h){var g=this;this.element=i;this.ul=i.children("ul");this.waiting=i.find(".ctd-river-waiting");this.change(h);this.refresh();i.scroll(function(){g.maybeLoad()});i.delegate("li","click",function(j){g.select(f(this),j)})};f.extend(a.prototype,{refresh:function(){this.deselect();this.visible=this.element.is(":visible")},show:function(){if(!this.visible){this.deselect();this.element.show();this.visible=true}},hide:function(){this.element.hide();this.visible=false},select:function(h,k){var j,i,l,g;if(h.hasClass("ctd-unselectable")||h==this.ctd_selected){return}this.deselect();this.ctd_selected=h.addClass("ctd-selected");j=h.outerHeight();i=this.element.height();l=h.position().top;g=this.element.scrollTop();if(l<0){this.element.scrollTop(g+l)}else{if(l+j>i){this.element.scrollTop(g+l-i+j)}}this.element.trigger("river-select",[h,k,this])},deselect:function(){if(this.ctd_selected){this.ctd_selected.removeClass("ctd-selected")}this.ctd_selected=false},prev:function(){if(!this.visible){return}var g;if(this.ctd_selected){g=this.ctd_selected.prev("li");if(g.length){this.select(g)}}},next:function(){if(!this.visible){return}var g=this.ctd_selected?this.ctd_selected.next("li"):f("li:not(.ctd-unselectable):first",this.element);if(g.length){this.select(g)}},ajax:function(j){var h=this,i=this.query.page==1?0:ClickToDonateLinks.minRiverAJAXDuration,g=ClickToDonateLinks.delayedCallback(function(k,l){h.process(k,l);if(j){j(k,l)}},i);this.query.ajax(g)},change:function(g){if(this.query&&this._search==g){return}this._search=g;this.query=new c(g);this.element.scrollTop(0)},process:function(h,l){var i="",j=true,g="",k=l.page==1;if(!h){if(k){i+='<li class="ctd-unselectable"><span class="item-title"><em>'+ctdLinksListL10n.noMatchesFound+"</em></span></li>"}}else{f.each(h,function(){g=j?"alternate":"";g+=this["title"]?"":" no-title";i+=g?'<li class="'+g+'">':"<li>";i+='<input type="hidden" class="item-permalink" value="'+this["permalink"]+'" />';i+='<input type="hidden" class="item-link" value="#ctd-'+this["ID"]+'" />';i+='<span class="item-title">';i+=this["title"]?this["title"]:ctdLinksListL10n.noTitle;i+='</span><span class="item-info">'+this["info"]+"</span></li>";j=!j})}this.ul[k?"html":"append"](i)},maybeLoad:function(){var h=this,i=this.element,g=i.scrollTop()+i.height();if(!this.query.ready()||g<this.ul.height()-ClickToDonateLinks.riverBottomThreshold){return}setTimeout(function(){var j=i.scrollTop(),k=j+i.height();if(!h.query.ready()||k<h.ul.height()-ClickToDonateLinks.riverBottomThreshold){return}h.waiting.show();i.scrollTop(j+h.waiting.outerHeight());h.ajax(function(){h.waiting.hide()})},ClickToDonateLinks.timeToTriggerRiver)}});c=function(g){this.page=1;this.allLoaded=false;this.querying=false;this.search=g};f.extend(c.prototype,{ready:function(){return !(this.querying||this.allLoaded)},ajax:function(i){var g=this,h={action:"ctd_get_links",page:this.page,_ajax_ctd_links_nonce:b.nonce.val()};if(this.search){h.search=this.search}this.querying=true;f.post(ajaxurl,h,function(j){g.page++;g.querying=false;g.allLoaded=!j;i(j,h)},"json")}});f(document).ready(ClickToDonateLinks.init)})(jQuery);